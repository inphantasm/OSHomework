# 第三问没看懂。使能和进入保护模式，我姑且认为是
# 使其“可以”进入，然后再让它进入。
# 进入只有一句call bootmain是我没想到的。


为什么要有A20？
# Intel早期的8086 CPU提供了20根地址线,可寻址空间范围即0~2^20(00000H~FFFFFH)的1MB内存空间。但8086的数据处理位宽位16位，无法直接寻址1MB内存空间，所以8086提供了段地址加偏移地址的地址转换机制。PC机的寻址结构是segment:offset，segment和offset都是16位的寄存器，最大值是0ffffh，换算成物理地址的计算方法是把segment左移4位，再加上offset，所以segment:offset所能表达的寻址空间最大应为0ffff0h + 0ffffh = 10ffefh（前面的0ffffh是segment=0ffffh并向左移动4位的结果，后面的0ffffh是可能的最大offset），这个计算出的10ffefh是多大呢？大约是1088KB，就是说，segment:offset的地址表示能力，超过了20位地址线的物理寻址能力。所以当寻址到超过1MB的内存时，会发生“回卷”（不会发生异常）。但下一代的基于Intel 80286 CPU的PC AT计算机系统提供了24根地址线，这样CPU的寻址范围变为 2^24=16M,同时也提供了保护模式，可以访问到1MB以上的内存了，此时如果遇到“寻址超过1MB”的情况，系统不会再“回卷”了，这就造成了向下不兼容。为了保持完全的向下兼容性，IBM决定在PC AT计算机系统上加个硬件逻辑，来模仿以上的回绕特征，于是出现了A20 Gate。
# 在保护模式下，为了使能所有地址位的寻址能力，需要打开A20地址线控制，即需要通过向键盘控制器8042发送一个命令来完成。键盘控制器8042将会将它的的某个输出引脚的输出置高电平，作为 A20 地址线控制的输入。一旦设置成功之后，内存将不会再被绕回(memory wrapping)，这样我们就可以寻址整个 286 的 16M 内存，或者是寻址 80386级别机器的所有4G内存了。

这一堆说了什么呢。
一开始的8086CPU设计成20位地址线，寻址到2^20，但是8086数据处理只有16位，不能寻找到所有的地址。所以寻址方式变成了seg:offset的形式。但是这种寻址方式超过了2^20的上限，于是会发生一种现象叫回卷。
新的CPU80286给出了24位地址线，发现可以一次寻找到所有的地址了，够用了，不会回卷了。因为Intel要做的向下兼容，所以决定加入一个硬件逻辑A20Gate，用来模拟这种现象。

如何开启A20？看bootasm.S
1. 清理寄存器
xorw %ax, %ax                                   
movw %ax, %ds                                   
movw %ax, %es                                   
movw %ax, %ss

2. 
# 等待8042 Input Buffer为空
seta20.1:
    inb $0x64, %al
    testb $0x2, %al
    jnz seta20.1
# 发送Write 8042 Output Port （P2）命令
    movb $0xd1, %al
    outb %al, $0x64
# 等待8042 Input Buffer为空
seta20.2:
    inb $0x64, %al
    testb $0x2, %al
    jnz seta20.2
# 将8042 Output Port（P2）得到字节的第2位置1
    movb $0xdf, %al
    outb %al, $0x60 

如何初始化GDT表？
lgdt gdtdesc

如何使A20进入保护模式？
https://www.cnblogs.com/cplover/archive/2013/10/16/3372232.html

看bootasm.S代码，发现肯定是CR0寄存器控制着是不是保护模式。
CR0寄存器
PE：CR0的位0是启用保护（Protection Enable）标志。当设置该位时即开启了保护模式；当复位时即进入实地址模式。这个标志仅开启段级保护，而并没有启用分页机制。若要启用分页机制，那么PE和PG标志都要置位
PG：CR0的位31是分页（Paging）标志。当设置该位时即开启了分页机制；当复位时则禁止分页机制，此时所有线性地址等同于物理地址。在开启这个标志之前必须已经或者同时开启PE标志。即若要启用分页机制，那么PE和PG标志都要置位。

当PE=1，就开启了保护模式。